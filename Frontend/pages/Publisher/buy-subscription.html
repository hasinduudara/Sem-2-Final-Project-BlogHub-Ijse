<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlogHub - AI Generator Subscription</title>
    <link rel="icon" href="/Frontend/assets/image/blogging.png" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Inter Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="/Frontend/css/Publisher/buy-subscription.css"
    />
  </head>
  <body>
    <div class="content-wrapper">
      <h1 class="mb-5">Go Premium with AI Article Generation!</h1>

      <div class="subscription-card">
        <div>
          <h3 class="plan-title">Premium Plan</h3>
          <p class="plan-price">LKR 4999<small>/lifetime</small></p>
          <ul class="plan-features">
            <li>Unlimited AI Articles</li>
            <li>Full Feature Access</li>
            <li>24/7 Dedicated Support</li>
            <li>Access to All AI Models & Betas</li>
            <li>Team Collaboration</li>
            <li>API Access</li>
          </ul>
        </div>
        <a
          href="http://localhost:5500/Frontend/pages/Publisher/payment.html"
          class="btn-subscribe"
          >Buy Subscription Now</a
        >
        <a
          href="/Frontend/pages/Publisher/AI-generated-article.html"
          class="btn-free-access"
          >Free Access</a
        >
      </div>
    </div>

    <!-- The Modal -->
    <div id="messageModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <p id="modal-text"></p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 for better alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // âœ… Check authentication status when page loads
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthenticationStatus();

        // Add click handler for Buy Subscription button
        document
          .querySelector(".btn-subscribe")
          .addEventListener("click", function (e) {
            e.preventDefault();
            handleSubscriptionPurchase();
          });
      });

      function checkAuthenticationStatus() {
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("userId");
        const userRole = localStorage.getItem("role");

        console.log("=== AUTHENTICATION CHECK ===");
        console.log("Token:", token ? "Present" : "Missing");
        console.log("UserId:", userId);
        console.log("User Role:", userRole);
        console.log("============================");

        // Update button behavior based on authentication status
        const buyButton = document.querySelector(".btn-subscribe");
        if (!token || !userId || userId === "null" || userId === "undefined") {
          buyButton.textContent = "Login to Subscribe";
          buyButton.style.backgroundColor = "#ff6b6b";
        } else {
          buyButton.textContent = "Buy Subscription Now";
          buyButton.style.backgroundColor = "";
        }
      }

      function handleSubscriptionPurchase() {
        const token = localStorage.getItem("token");
        const userId = localStorage.getItem("userId");
        const userRole = localStorage.getItem("role");

        if (!token || !userId || userId === "null" || userId === "undefined") {
          // User not logged in - show login prompt
          Swal.fire({
            icon: "info",
            title: "Login Required",
            text: "Please log in to purchase a subscription.",
            showCancelButton: true,
            confirmButtonText: "Go to Login",
            cancelButtonText: "Cancel",
            confirmButtonColor: "#333333",
          }).then((result) => {
            if (result.isConfirmed) {
              // Store the intended action in localStorage so we can redirect back after login
              localStorage.setItem("redirectAfterLogin", "subscription");
              window.location.href =
                "http://localhost:5500/Frontend/pages/login-and-register/login-and-register.html";
            }
          });
        } else if (userRole !== "PUBLISHER") {
          // User is logged in but not a publisher
          Swal.fire({
            icon: "warning",
            title: "Publisher Account Required",
            text: "AI article generation is only available for Publisher accounts. Please create a Publisher account to continue.",
            confirmButtonText: "Create Publisher Account",
            showCancelButton: true,
            cancelButtonText: "Cancel",
          }).then((result) => {
            if (result.isConfirmed) {
              // Redirect to registration page with publisher role pre-selected
              window.location.href =
                "http://localhost:5500/Frontend/pages/login-and-register/login-and-register.html?role=publisher";
            }
          });
        } else {
          // User is properly authenticated as publisher - proceed to payment
          window.location.href =
            "http://localhost:5500/Frontend/pages/Publisher/payment.html";
        }
      }
    </script>
  </body>
</html>
