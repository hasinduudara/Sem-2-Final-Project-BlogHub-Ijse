<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlogHub - AI Generator Subscription</title>
    <link rel="icon" href="/Frontend/assets/image/blogging.png" />

    <!-- Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval'
        https://cdnjs.cloudflare.com
        https://cdn.jsdelivr.net
        https://www.payhere.lk;
      style-src 'self' 'unsafe-inline'
        https://cdn.jsdelivr.net
        https://fonts.googleapis.com;
      font-src 'self'
        https://fonts.gstatic.com;
      img-src 'self' data: https:;
      frame-src 'self'
        https://sandbox.payhere.lk
        https://www.payhere.lk;
      connect-src 'self'
        https://api.payhere.lk
        https://sandbox.payhere.lk
        https://cdn.jsdelivr.net
        http://localhost:8080;
    "
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Inter Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #000000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        overflow: auto;
        color: #f0f0f0;
      }
      #three-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        opacity: 0.7;
      }
      .content-wrapper {
        position: relative;
        z-index: 1;
        padding: 40px 20px;
        max-width: 1200px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      h1 {
        color: #ffffff;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        margin-bottom: 40px;
      }
      .subscription-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 30px;
        margin-bottom: 30px;
        color: #f0f0f0;
        max-width: 400px;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.3s ease-in-out;
        animation: floatEffect 5s ease-in-out infinite;
      }
      @keyframes floatEffect {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }
      .subscription-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.3);
      }
      .plan-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 15px;
        color: #ffffff;
      }
      .plan-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: #ffffff;
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }
      .plan-price small {
        font-size: 1rem;
        font-weight: 400;
        color: #cccccc;
      }
      .plan-features {
        list-style: none;
        padding: 0;
        margin-bottom: 30px;
        text-align: left;
        flex-grow: 1;
      }
      .plan-features li {
        margin-bottom: 10px;
        font-size: 1.05rem;
        color: #e0e0e0;
        display: flex;
        align-items: center;
      }
      .plan-features li::before {
        content: "âœ“";
        color: #ffffff;
        font-weight: bold;
        margin-right: 10px;
        font-size: 1.2rem;
      }
      .btn-subscribe {
        background-color: #333333;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1.1rem;
        width: 100%;
        font-weight: 600;
        letter-spacing: 0.8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .btn-subscribe:hover {
        background-color: #555555;
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        color: white;
      }
      .btn-free-access {
        background: transparent;
        color: #ffffff;
        padding: 12px 25px;
        border: 1px solid #ffffff;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1.1rem;
        width: 100%;
        font-weight: 600;
        letter-spacing: 0.8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        text-decoration: none;
        display: inline-block;
        margin-top: 15px;
      }
      .btn-free-access:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }
      .modal-content {
        background: rgba(255, 255, 255, 0.1);
        margin: 15% auto;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 80%;
        max-width: 400px;
        border-radius: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        animation-name: animatetop;
        animation-duration: 0.4s;
      }
      .modal-content p {
        color: #f0f0f0;
        font-size: 1.1rem;
        margin: 0;
      }
      @keyframes animatetop {
        from {
          top: -300px;
          opacity: 0;
        }
        to {
          top: 0;
          opacity: 1;
        }
      }
      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close-btn:hover,
      .close-btn:focus {
        color: white;
        text-decoration: none;
        cursor: pointer;
      }
      @media (max-width: 768px) {
        h1 {
          font-size: 2rem;
          margin-bottom: 30px;
        }
        .plan-title {
          font-size: 1.5rem;
        }
        .plan-price {
          font-size: 2rem;
        }
        .subscription-card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 3D Canvas -->
    <canvas id="three-canvas"></canvas>

    <div class="content-wrapper">
      <h1 class="mb-5">Go Premium with AI Article Generation!</h1>

      <div class="subscription-card">
        <div>
          <h3 class="plan-title">Premium Plan</h3>
          <p class="plan-price">LKR 4999<small>/month</small></p>
          <ul class="plan-features">
            <li>Unlimited AI Articles</li>
            <li>Full Feature Access</li>
            <li>24/7 Dedicated Support</li>
            <li>Access to All AI Models & Betas</li>
            <li>Team Collaboration</li>
            <li>API Access</li>
          </ul>
        </div>
        <button
          type="button"
          class="btn-subscribe"
          onclick="initiatePayHere('premium')"
        >
          Subscribe Now
        </button>
        <a
          href="/Frontend/pages/Publisher/AI-generated-article.html"
          class="btn-free-access"
          >Access Free Version</a
        >
      </div>
    </div>

    <!-- The Modal -->
    <div id="messageModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <p id="modal-text"></p>
      </div>
    </div>

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- PayHere JS -->
    <script src="https://www.payhere.lk/lib/payhere.js"></script>
    <script>
      // --- Three.js background setup ---
      let scene, camera, renderer, icosahedron, particles, lines;
      let mouseX = 0,
        mouseY = 0;
      let windowHalfX = window.innerWidth / 2;
      let windowHalfY = window.innerHeight / 2;

      function initThreeJS() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({
          canvas: document.getElementById("three-canvas"),
          alpha: true,
          antialias: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const icoGeometry = new THREE.IcosahedronGeometry(2.5, 1);
        const icoMaterial = new THREE.MeshBasicMaterial({
          color: 0xcccccc,
          wireframe: true,
          transparent: true,
          opacity: 0.15,
          blending: THREE.AdditiveBlending,
        });
        icosahedron = new THREE.Mesh(icoGeometry, icoMaterial);
        scene.add(icosahedron);

        const particleCount = 700;
        const particleGeometry = new THREE.BufferGeometry();
        const particlePositions = new Float32Array(particleCount * 3);
        const particleColors = new Float32Array(particleCount * 3);
        const particleColor = new THREE.Color(0x888888);

        for (let i = 0; i < particleCount; i++) {
          const r = 4 + Math.random() * 4;
          const theta = Math.random() * Math.PI * 2;
          const phi = Math.acos(Math.random() * 2 - 1);
          particlePositions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
          particlePositions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
          particlePositions[i * 3 + 2] = r * Math.cos(phi);
          particleColor.toArray(particleColors, i * 3);
        }
        particleGeometry.setAttribute(
          "position",
          new THREE.BufferAttribute(particlePositions, 3)
        );
        particleGeometry.setAttribute(
          "color",
          new THREE.BufferAttribute(particleColors, 3)
        );

        const particleMaterial = new THREE.PointsMaterial({
          size: 0.04,
          vertexColors: true,
          transparent: true,
          opacity: 0.4,
          blending: THREE.AdditiveBlending,
          sizeAttenuation: true,
        });
        particles = new THREE.Points(particleGeometry, particleMaterial);
        scene.add(particles);

        const lineMaterial = new THREE.LineBasicMaterial({
          color: 0x666666,
          transparent: true,
          opacity: 0.04,
          blending: THREE.AdditiveBlending,
        });
        const lineGeometry = new THREE.BufferGeometry();
        const maxLineInstances = particleCount * 4;
        const linePositions = new Float32Array(maxLineInstances * 2 * 3);
        lineGeometry.setAttribute(
          "position",
          new THREE.BufferAttribute(linePositions, 3)
        );
        lines = new THREE.LineSegments(lineGeometry, lineMaterial);
        scene.add(lines);

        window.addEventListener("resize", onWindowResizeThreeJS, false);
        document.addEventListener(
          "mousemove",
          onDocumentMouseMoveThreeJS,
          false
        );
        document.addEventListener(
          "touchstart",
          onDocumentTouchStartThreeJS,
          false
        );
        document.addEventListener(
          "touchmove",
          onDocumentTouchMoveThreeJS,
          false
        );
      }

      function onWindowResizeThreeJS() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onDocumentMouseMoveThreeJS(event) {
        mouseX = event.clientX - windowHalfX;
        mouseY = event.clientY - windowHalfY;
      }

      function onDocumentTouchStartThreeJS(event) {
        if (event.touches.length === 1) {
          mouseX = event.touches[0].pageX - windowHalfX;
          mouseY = event.touches[0].pageY - windowHalfY;
        }
      }

      function onDocumentTouchMoveThreeJS(event) {
        if (event.touches.length === 1) {
          event.preventDefault();
          mouseX = event.touches[0].pageX - windowHalfX;
          mouseY = event.touches[0].pageY - windowHalfY;
        }
      }

      function animateThreeJS() {
        requestAnimationFrame(animateThreeJS);
        icosahedron.rotation.x += 0.0003;
        icosahedron.rotation.y += 0.0006;
        particles.rotation.y += 0.0004;
        particles.rotation.x += 0.0001;

        const currentLinePositions = lines.geometry.attributes.position.array;
        let lineIndex = 0;
        const particlePositionsArray =
          particles.geometry.attributes.position.array;
        const tempParticle1 = new THREE.Vector3();
        const tempParticle2 = new THREE.Vector3();
        for (let i = 0; i < currentLinePositions.length; i++)
          currentLinePositions[i] = 0;

        for (let i = 0; i < particlePositionsArray.length / 3; i++) {
          tempParticle1
            .set(
              particlePositionsArray[i * 3],
              particlePositionsArray[i * 3 + 1],
              particlePositionsArray[i * 3 + 2]
            )
            .applyMatrix4(particles.matrixWorld);

          for (let j = i + 1; j < particlePositionsArray.length / 3; j++) {
            tempParticle2
              .set(
                particlePositionsArray[j * 3],
                particlePositionsArray[j * 3 + 1],
                particlePositionsArray[j * 3 + 2]
              )
              .applyMatrix4(particles.matrixWorld);

            if (tempParticle1.distanceTo(tempParticle2) < 0.8) {
              currentLinePositions[lineIndex++] = tempParticle1.x;
              currentLinePositions[lineIndex++] = tempParticle1.y;
              currentLinePositions[lineIndex++] = tempParticle1.z;
              currentLinePositions[lineIndex++] = tempParticle2.x;
              currentLinePositions[lineIndex++] = tempParticle2.y;
              currentLinePositions[lineIndex++] = tempParticle2.z;
            }
          }
        }
        lines.geometry.attributes.position.needsUpdate = true;
        lines.geometry.setDrawRange(0, lineIndex);

        camera.position.x += (mouseX * 0.0003 - camera.position.x) * 0.05;
        camera.position.y += (-mouseY * 0.0003 - camera.position.y) * 0.05;
        camera.lookAt(scene.position);
        renderer.render(scene, camera);
      }

      // --- PayHere Integration ---
      function initiatePayHere(plan) {
        // Get user data from localStorage
        let user = JSON.parse(localStorage.getItem("user"));

        // If no user found, create a demo user with email
        if (!user || !user.email) {
          const demoUser = {
            id: Date.now(),
            name: "Demo User",
            email: "demo@bloghub.com",
            role: "PUBLISHER",
          };
          localStorage.setItem("user", JSON.stringify(demoUser));
          user = demoUser;
        }

        const payment = {
          sandbox: true, // Use sandbox for testing
          merchant_id: "1231966", // Your provided Merchant ID
          return_url:
            window.location.origin +
            "/Frontend/pages/Publisher/AI-generated-article.html",
          cancel_url: window.location.href,
          notify_url: "http://localhost:8080/api/subscription/notify",
          order_id: "BLOGHUB_SUB_" + new Date().getTime(),
          items: "BlogHub Premium AI Generator Subscription",
          amount: 4999.0,
          currency: "LKR",
          first_name: user.name || "BlogHub User",
          last_name: "",
          email: user.email,
          phone: "",
          address: "",
          city: "",
          country: "Sri Lanka",
        };

        // PayHere event handlers
        payhere.onCompleted = function onCompleted(orderId) {
          console.log("Payment completed. OrderID:" + orderId);
          showModal("ðŸŽ‰ Payment successful! Activating your subscription...");

          // Call backend to activate subscription
          activateSubscriptionAfterPayment(user.email, plan, orderId);
        };

        payhere.onDismissed = function onDismissed() {
          console.log("Payment dismissed");
          showModal(
            "Payment was cancelled. Please try again if you wish to subscribe."
          );
        };

        payhere.onError = function onError(error) {
          console.log("Payment error:" + error);
          showModal("âŒ Payment failed. Please try again.");
        };

        // Start the payment
        payhere.startPayment(payment);
      }

      // Function to activate subscription after successful payment
      async function activateSubscriptionAfterPayment(email, plan, orderId) {
        try {
          const response = await fetch(
            `http://localhost:8080/api/subscription/${email}?plan=${plan}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                orderId: orderId,
                paymentStatus: "COMPLETED",
              }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            // Update user with premium status
            let user = JSON.parse(localStorage.getItem("user"));
            user.isPremium = true;
            user.subscriptionPlan = plan;
            localStorage.setItem("user", JSON.stringify(user));

            showModal("âœ¨ Subscription activated successfully! Redirecting...");

            // Redirect after 3 seconds
            setTimeout(() => {
              window.location.href =
                "/Frontend/pages/Publisher/AI-generated-article.html";
            }, 3000);
          } else {
            showModal(
              "âŒ " + (result.message || "Failed to activate subscription.")
            );
          }
        } catch (error) {
          console.error("Subscription activation error:", error);
          showModal("âŒ Network error. Please contact support.");
        }
      }

      // Show modal with message
      function showModal(message) {
        const modal = document.getElementById("messageModal");
        const modalText = document.getElementById("modal-text");
        modalText.textContent = message;
        modal.style.display = "block";
      }

      // Modal functionality
      const modal = document.getElementById("messageModal");
      const span = document.getElementsByClassName("close-btn")[0];
      if (span) {
        span.onclick = () => (modal.style.display = "none");
      }
      window.onclick = (event) => {
        if (event.target === modal) modal.style.display = "none";
      };

      window.onload = () => {
        initThreeJS();
        animateThreeJS();
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
