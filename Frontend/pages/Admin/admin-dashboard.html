<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlogHub - Admin Dashboard | BlogHub</title>
    <link rel="icon" href="/Frontend/assets/image/blogging.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link rel="stylesheet" href="/Frontend/css/Admin/admin-dashboard.css" />
  </head>
  <body>
    <canvas id="p5-canvas"></canvas>

    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">
          <i class="fas fa-chart-line me-2"></i>Admin Dashboard
        </a>
        <div class="d-flex align-items-center">
          <span class="text-white me-3 d-none d-md-block"
            >Welcome, <span id="userDisplay">Admin</span></span
          >
          <button id="logoutBtn" class="btn">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="welcome-section animate__animated animate__fadeInDown">
        <h1 class="display-4 fw-bold text-center">Welcome, Admin!</h1>
        <p class="lead text-muted text-center">
          Manage your BlogHub platform efficiently with powerful tools and
          insights.
        </p>
      </div>

      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
        <div class="col animate__animated animate__fadeInUp">
          <a href="./articles.html" class="card-link">
            <div class="card p-4 text-center dashboard-card">
              <div class="mx-auto mb-3 icon-container">
                <i class="fas fa-newspaper fa-2x text-primary"></i>
              </div>
              <h5 class="fw-bold">Manage Articles</h5>
              <p class="text-muted mb-0">
                Review and delete published articles
              </p>
            </div>
          </a>
        </div>

        <div class="col animate__animated animate__fadeInUp">
          <a href="./users.html" class="card-link">
            <div class="card p-4 text-center dashboard-card">
              <div class="mx-auto mb-3 icon-container">
                <i class="fas fa-users fa-2x text-primary"></i>
              </div>
              <h5 class="fw-bold">Users & Publishers</h5>
              <p class="text-muted mb-0">
                View and manage all registered accounts
              </p>
            </div>
          </a>
        </div>

        <div class="col animate__animated animate__fadeInUp">
          <a href="./payments.html" class="card-link">
            <div class="card p-4 text-center dashboard-card">
              <div class="mx-auto mb-3 icon-container">
                <i class="fas fa-credit-card fa-2x text-primary"></i>
              </div>
              <h5 class="fw-bold">Payments</h5>
              <p class="text-muted mb-0">
                Review payment history and statistics
              </p>
            </div>
          </a>
        </div>

        <div class="col animate__animated animate__fadeInUp">
          <a href="./admin-profile.html" class="card-link">
            <div class="card p-4 text-center dashboard-card">
              <div class="mx-auto mb-3 icon-container">
                <i class="fas fa-user-shield fa-2x text-primary"></i>
              </div>
              <h5 class="fw-bold">Admin Management</h5>
              <p class="text-muted mb-0">Update profile and add new admins</p>
            </div>
          </a>
        </div>
      </div>
    </div>

    <footer class="admin-footer">
      <p class="mb-0">Â© 2025 BlogHub Admin Dashboard. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Background animation with p5.js
      function setup() {
        const canvas = createCanvas(windowWidth, windowHeight);
        canvas.position(0, 0);
        canvas.style("z-index", "-1");
        background(248, 249, 250);
      }

      function draw() {
        noStroke();
        fill(200, 220, 255, 20);
        // Create subtle moving particles for background
        for (let i = 0; i < 5; i++) {
          let x = noise(frameCount * 0.001 * i) * width;
          let y = noise(frameCount * 0.001 * i + 100) * height;
          let size = noise(frameCount * 0.001 * i + 200) * 15;
          ellipse(x, y, size, size);
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }

      // Authentication check with race condition prevention
      document.addEventListener("DOMContentLoaded", function () {
        // Add delay to ensure localStorage is populated after redirect
        setTimeout(function() {
          checkAuthentication();
        }, 100);

        function checkAuthentication() {
          // Check if user is authenticated and is an admin
          const token = localStorage.getItem("token");
          const role = localStorage.getItem("role");
          const username = localStorage.getItem("username");

          console.log("HTML Auth Check - Token:", token);
          console.log("HTML Auth Check - Role:", role);
          console.log("HTML Auth Check - Username:", username);

          // If no token or role on first check, retry after delay
          if (!token || !role) {
            console.log("HTML Auth - First check failed, retrying...");
            setTimeout(function() {
              const retryToken = localStorage.getItem("token");
              const retryRole = localStorage.getItem("role");
              const retryUsername = localStorage.getItem("username");

              console.log("HTML Auth Retry - Token:", retryToken);
              console.log("HTML Auth Retry - Role:", retryRole);

              if (!retryToken) {
                alert("Please log in first.");
                window.location.href = "http://127.0.0.1:5500/Frontend/pages/login-and-register/login-and-register.html";
                return;
              }

              if (retryRole !== "ADMIN") {
                alert("Access denied. Please log in as an admin.");
                window.location.href = "http://127.0.0.1:5500/Frontend/pages/login-and-register/login-and-register.html";
                return;
              }

              // Authentication successful
              console.log("HTML Auth - Welcome, Admin!");
              initializePage(retryUsername);
            }, 500);
            return;
          }

          if (role !== "ADMIN") {
            alert("Access denied. Please log in as an admin.");
            window.location.href = "http://127.0.0.1:5500/Frontend/pages/login-and-register/login-and-register.html";
            return;
          }

          // If we get here, user is authenticated as admin
          console.log("HTML Auth - Welcome, Admin!");
          initializePage(username);
        }

        function initializePage(username) {
          // Display username in the UI
          const userDisplayElement = document.getElementById("userDisplay");
          if (userDisplayElement && username) {
            userDisplayElement.textContent = username;
          }

          // Add logout functionality
          const logoutBtn = document.getElementById("logoutBtn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", function () {
              // Clear localStorage
              localStorage.removeItem("token");
              localStorage.removeItem("userId");
              localStorage.removeItem("username");
              localStorage.removeItem("role");
              localStorage.removeItem("email");

              // Redirect to login page
              window.location.href = "http://127.0.0.1:5500/Frontend/pages/login-and-register/login-and-register.html";
            });
          }
        }
      });
    </script>
  </body>
</html>
